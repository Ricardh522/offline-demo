define(["dojo/_base/declare","dojo/_base/array","dojo/parser","dojo/ready","dojo/dom-style","dojo/dom","dojo/dom-class","dojo/on","dojo/mouse","dojo/Deferred","dojo/dom-attr","dojo/promise/all","utils/debouncer","esri/geometry/webMercatorUtils","esri/tasks/Geoprocessor","dijit/_WidgetBase","esri/tasks/IdentifyTask","esri/tasks/IdentifyParameters","esri/tasks/IdentifyResult","esri/tasks/FeatureSet","esri/layers/ArcGISDynamicMapServiceLayer","esri/layers/ImageParameters","esri/geometry/Extent","esri/dijit/PopupTemplate","esri/layers/FeatureLayer","esri/arcgis/utils","esri/graphicsUtils","esri/geometry/geometryEngine","esri/tasks/query","esri/tasks/QueryTask","esri/geometry/Point","esri/geometry/Polygon","esri/layers/LabelLayer","esri/renderers/SimpleRenderer","esri/symbols/TextSymbol","esri/request","dojo/dom-construct","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol","esri/Color","esri/dijit/util/busyIndicator","esri/dijit/LayerList","javascript/utils/offline-tiles-advanced-min.js"],function(e,n,o,t,a,l,r,s,f,d,c,u,g,p,m,v,y,h,b,S,W,w,_,L,T,D,M,E,I,B,x,j,N,F,k,A,P,C,q,z,R,U){return e("OfflineWidget",[v],{indexes:[],map:"",onlineTest:"",editStore:{DB_NAME:"features_store",DB_STORE_NAME:"features",DB_UID:"objectid"},initialize:function(){offlineWidget.initModules(null,function(e){offlineWidget.init(null,function(e){console.log("offline widget has been fully initialized")})})},validate:function(e){!function(){var o=l.byId("downloadTiles"),i=l.byId("downloadFeatures"),t=l.byId("clearButton"),a=[o,i,t];offlineWidget.validateOnline(function(o){"failed"!==o?(_isOnline=!0,_isOffline=!1,n.forEach(a,function(e){r.contains(e,"disabled")===!0&&r.remove(e,"disabled")}),e(_isOnline)):(_isOnline=!1,_isOffline=!0,n.forEach(a,function(e){r.contains(e,"disabled")===!1&&r.add(e,"disabled")}),e(_isOnline))})}()},startup:function(e,n){var o=this.editStore,i=o.DB_NAME,t=o.DB_STORE_NAME;this.onlineTest=e.onlineTest,this.mapService=e.mapService,this.map=e.map,offlineWidget.validate(function(e){console.log(e)}),Offline.on("up down",offlineWidget.updateState),"up"===Offline.state?zoom=18:void 0!==localStorage.offlineZoom&&(zoom=localStorage.offlineZoom),function(){request=indexedDB.open(i,11),request.onupgradeneeded=function(e){var n=e.target.result,i=n.createObjectStore(t,{keyPath:"id"});i.createIndex("by_id","id",{unique:!0});o._isDBInit=!0,n.close()},request.onsuccess=function(e){db=e.target.result,o._isDBInit=!0,db.close()},request.onerror=function(){o._isDBInit=!1,console.log(request.error)}}(),$("#downloadTiles, #downloadFeatures, #clearButton").on("mousedown",function(e){e.preventDefault(),$(this).css("transform","scale(1.25, 1.25)")}),$("#downloadTiles, #downloadFeatures, #clearButton").on("mouseout",function(e){e.preventDefault(),$(this).css("transform","scale(1, 1)")}),$("#downloadTiles").on("mouseup",function(e){e.preventDefault(),$(this).css("-webkit-transform","scale(1, 1)"),offlineWidget.downloadTiles()}),$("#downloadFeatures").on("mouseup",function(e){e.preventDefault(),$(this).css("-webkit-transform","scale(1, 1)"),offlineWidget.startFeatureDownload(null)}),$("#clearButton").on("mouseup",function(e){function n(e){var n=new d,o=r(e,t,"readwrite"),i=o.clear();return i.onsuccess=function(e){console.log("Store cleared"),n.resolve("sucess")},i.onerror=function(e){console.error("clearObjectStore:",e.target.errorCode),n.resolve("fail")},n.promise}e.preventDefault(),$(this).css("-webkit-transform","scale(1, 1)"),offlineWidget.offlineMap.showLoading();var a,l=function(e,n){request=indexedDB.open(i,11),request.onupgradeneeded=function(e){var n=e.target.result,i=n.createObjectStore(t,{keyPath:"id"});i.createIndex("by_id","id",{unique:!0});o._isDBInit=!0,n.close()},request.onsuccess=function(e){a=e.target.result,o._isDBInit=!0,n(a)},request.onerror=function(){o._isDBInit=!1,console.log(request.error)}},r=function(e,n,o){var i=e.transaction(n,o);return i.onabort=function(){console.log(i.error)},i.objectStore(n)};l(null,function(e){a=e;var o=(offlineWidget.map,n(a));o.then(function(e){var n=function(e){a.close(),offlineWidget.clearMap(null,function(n){e()})};n(function(e){offlineWidget.displayMap()})})})})},initModules:function(e,n){!function(){offlineWidget.offlineMap={startup:function(){console.log("OfflineMapStartup Function fired");var e=l.byId("loadingImg"),n=(offlineWidget.map,R.create({backgroundOpacity:.01,target:e,imageUrl:"images/loading-throb.gif",zIndex:100}));n.hide(),this.handle=n,a.set(e,"visibility","hidden")},showLoading:function(){var e=(l.byId("loadingImg"),offlineWidget.map);this.handle.show(),e.disableMapNavigation(),e.disablePan()},hideLoading:function(){var e=(l.byId("loadingImg"),offlineWidget.map);this.handle.hide(),e.enableMapNavigation(),e.enablePan()},initEvents:function(){var e=offlineWidget.map;e.on("zoom-end",function(e){_currentExtent=e.extent,offlineWidget.updateLocalStorage(),Offline.check()}),e.on("pan-end",function(e){_currentExtent=e.extent,offlineWidget.updateLocalStorage(),Offline.check()}),e.on("pan",function(e){var n=offlineWidget.offlineMap;n.hideLoading()}),e.on("zoom-start",function(e){var n=offlineWidget.offlineMap;n.showLoading()}),e.on("zoom-end",function(e){var n=offlineWidget.offlineMap;n.hideLoading()}),g.setOrientationListener(250,function(){console.log("orientation"),orientationChange=!0}),document.addEventListener("touchmove",function(e){$(e.target).parents().hasClass("touch-moveable")||(e.preventDefault(),e.stopPropagation())},!1)}},offlineWidget.offlineTiles={startup:function(){"up"===Offline.state&&(_isOnline=!0);var e=new O.esri.Tiles.OfflineTileEnablerLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer",function(e){console.log("Offline tile lib enabled. App is: "+Offline.state)},_isOnline);e._minZoom=14,e._maxZoom=19,this.tileLayer=e},minZoomAdjust:-1,maxZoomAdjust:4,resetZoom:15,_currentZoom:null,EXTENT_BUFFER:0,_currentExtent:null,_wantToCancel:!1,_downloadState:"downloaded",initOffline:function(){console.log("extending"),Offline.on("up",this.goOnline),Offline.on("down",this.goOffline)},updateTileCountEstimation:function(){console.log("updating");var e=this.tileLayer,n=offlineWidget.map,o={tileCount:0,sizeBytes:0},i=14,t=19;this.tileLayer.estimateTileSize(function(a){for(var l=[],r=i;t>=r;r++){var s=e.getLevelEstimation(n.extent,r,a);if(o.tileCount+=s.tileCount,o.sizeBytes+=s.sizeBytes,s.tileCount>0&&(console.log(rowContent),l.push(newstring)),o.tileCount>5e3)break}})},cancel:function(){cancelRequested=!0}},offlineWidget.offlineMap.startup(),offlineWidget.offlineTiles.startup(),n(!0)}()},startFeatureDownload:function(e,o){function i(e,n,o){e.queryIds(n,function(n){n?(e.setDefinitionExpression("OBJECTID IN ("+n.join(",")+")"),o(e)):o(!1)})}this.offlineMap.showLoading();var t=(l.byId("downloadTiles"),l.byId("downloadFeatures"),l.byId("clearButton"),this.map),a=this.mapService.url;offlineWidget.clearMap(null,function(e){var o=t.extent,l=[],r=offlineWidget.mapService.visibleLayers,s=n.map(r,function(e){var n=new d,o=a+"/"+e,i=new A({url:o,content:{f:"json"},handleAs:"json",callbackParamName:"callback"});return n.resolve(i),n});u(s).then(function(e){var r={polys:[],lines:[],points:[],labels:[]},s=n.map(e,function(e){var n=new d;return e.then(function(e){if("Feature Layer"===e.type){var t,l=e.id,s=e.geometryType,f=e.fields,d=[];for(t=0;t<f.length;t++){var c=f.shift(),u={fieldName:c.name,label:c.alias,visible:!0};d.push(u)}var g=new L({title:e.name,fieldInfos:d,showAttachments:!1}),p=a+"/"+l,m=new T(p,{mode:T.MODE_SNAPSHOT,infoTemplate:g,outFields:["*"],visible:!0}),v=new I;v.geometry=o,v.returnGeometry=!1,i(m,v,function(e){if(e!==!1){switch(s){case"esriGeometryPolygon":r.polys.push(e);break;case"esriGeometryPolyline":r.lines.push(e);break;case"esriGeometryPoint":r.points.push(e)}n.resolve(!0)}else n.resolve(!1)})}else n.resolve(!1)}),n.promise});u(s).then(function(e){var o=t.on("layers-add-result",function(e){o.remove(),offlineWidget.toc.refresh();var i=[],a=t.graphicsLayerIds;n.forEach(a,function(e){var n=new d,o=t.getLayer(e);if(0===o.graphics.length){console.log("graphics have not be created yet");var a=o.on("update-end",function(e){a.remove(),n.resolve(o)})}else o.graphics.length>0&&n.resolve(o);i.push(n)});var l=u(i);l.then(function(e){console.log(e),offlineWidget.initOfflineDatabase(e)})}),i=r.polys.concat(r.lines,r.points),a=[];for(l=0;l<i.length;l+=1){var s={layer:i[l]};a.push(s)}offlineWidget.toc.layers=a,t.addLayers(i)})})})},init:function(e,n){function o(){var e=$("#splashPage"),o=$(".container-fluid");o.css("visibility","visible"),o.css("opacity",1),e.css("opacity",0),e.css("visibility","hidden"),i.offlineMap.initEvents(),n(!0)}var i=this,t=this.map,a=this.mapService,l=offlineWidget.offlineTiles.tileLayer;t.addLayers([l,a]),o()},updateState:function(){"up"===Offline.state?offlineWidget.toggleStateUp(!0):offlineWidget.toggleStateUp(!1)},toggleStateUp:function(e){var o=l.byId("downloadTiles"),i=l.byId("downloadFeatures"),t=l.byId("clearButton"),a=[o,i,t],s=offlineWidget.offlineTiles.tileLayer;e?(s.goOnline(),offlineWidget.clearMap(null,function(e){offlineWidget.displayMap(),n.forEach(a,function(e){r.contains(e,"disabled")===!0&&r.remove(e,"disabled")})})):(s.goOffline(),offlineWidget.clearMap(null,function(e){n.forEach(a,function(e){r.contains(e,"disabled")===!1&&r.add(e,"disabled")})}))},validateOnline:function(e){!function(n){Offline.check();var o=new XMLHttpRequest,i=1e5,t=setTimeout(function(){o.abort(),e("failed")},i);if("up"===Offline.state){o.open("GET",offlineWidget.onlineTest,!1),o.onreadystatechange=function(){o.status;4==this.readyState&&(4==this.readyState&&200==this.status?(clearTimeout(t),o.onload=function(){o=null,e(!0)}):(console.log("verifyOffline failed"),o=null,e("failed")))},o.onerror=function(n){console.log("verifyOnline failed: "+n),e("failed")};try{o.send(null)}catch(a){console.log(a)}}else e("failed")}()},goOnlineOffline:function(){var e=document.getElementById("state-span");" Up"==e.innerHTML?(toggleStateUp(!1),console.log("Map is offline")):(toggleStateUp(!0),console.log("Map is online"))},downloadTiles:function(e){this.offlineMap.showLoading();var n=this.offlineTiles.tileLayer,o=this.offlineTiles.minZoomAdjust,i=this.offlineTiles.maxZoomAdjust,t=this.offlineTiles.EXTENT_BUFFER,a=this.map;n.deleteAllTiles(function(e,l){new d;if(e===!1)alert("There was a problem deleting the tile cache");else{console.log("success deleting tile cache");this.data;if("downloading"==offlineWidget.downloadState)console.log("cancel!"),_wantToCancel=!0;else{var r=n.getMinMaxLOD(o,i),s=n.getExtentBuffer(t,a.extent);_wantToCancel=!1;var f="<span id='message' style='z-index: 100; position: absolute; top: 0px; right: 5px; font: black; arial; text-shadow: 1px 1px 3px white'>downloading tiles...</span>";$("#navbar").append(f),n.prepareForOffline(r.min,r.max,s,offlineWidget.reportProgress.bind(this)),offlineWidget.downloadState="downloading"}}}.bind(this))},reportProgress:function(e){if(e.hasOwnProperty("countNow"),e.finishedDownloading){var n=offlineWidget.offlineMap;$("#navbar > span").remove(),e.cancelRequested?(offlineWidget.downloadState="cancelled",alert("Tile download was cancelled"),n.hideLoading()):(offlineWidget.downloadState="downloaded",alert("Tile download complete"),n.hideLoading(),offlineWidget.offlineTiles.tileLayer.saveToFile("myOfflineTilesLayer.csv",function(e,n){console.log(e),console.log(n)}))}return _wantToCancel},clearMap:function(e,n){var o=this.map,t=o.graphicsLayerIds,a=o.layerIds,l=a.concat(t);if(l.length>1)for(i=1;i<l.length;i++){var r=o.getLayer(l[i]);o.removeLayer(r)}0===o.graphicsLayerIds.length&&(console.log("All graphic layers removed from Map"),n()),offlineWidget.hasOwnProperty("toc")&&(offlineWidget.layers=null)},displayMap:function(){var e=this.map,n=this.mapService,o=e.on("layer-add-result",function(e){console.log("Map Service Added back to Map"),o.remove(),offlineWidget.offlineMap.hideLoading()});offlineWidget.toc.layers=n,offlineWidget.toc.refresh(),e.addLayer(n)},updateLocalStorage:function(){var e=offlineWidget.map,n=e.getZoom(),o=JSON.stringify(e.extent);"undefined"!=typeof Storage?(localStorage.offlineZoom=n,localStorage.offlineExtent=o,console.log("Done updating zoom and extent to localStorage.")):alert("The offline library is not supported on this browser.")},initOfflineDatabase:function(e){offlineWidget.buildDatabase(e,function(e){console.log(e);var n=l.byId("clearButton"),o=l.byId("downloadTiles"),i=l.byId("downloadFeatures");if(_isOnline===!0){var t=1;0===t?offlineWidget.clearMap(null,function(e){offlineWidget.displayMap(),r.remove(o,"disabled"),r.remove(n,"disabled"),r.remove(i,"disabled")}):offlineWidget.clearMap(null,function(e){offlineWidget.loadOffline()})}else offlineWidget.clearMap(null,function(e){offlineWidget.loadOffline(),r.add(o,"disabled"),r.add(n,"disabled"),r.add(i,"disabled")})})},initPanZoomListeners:function(){var e=offlineWidget.map;e.on("zoom-end",function(e){offlineWidget.updateLocalStorage(),offlineWidget.validate(function(e){Offline.check()})}),e.on("pan-end",function(e){offlineWidget.updateLocalStorage(),Offline.check(),"up"===Offline.state?(_isOnline=!0,_isOffline=!1):(_isOnline=!1,_isOffline=!0),offlineWidget.validate(function(e){console.log(_isOnline+" :ArcServer machine accessible")})})},getFeatureLayerJSONDataStore:function(e,n){var o,i=offlineWidget.getFeatureLayerJSON(e);o="object"==typeof i?!0:!1,n(o,i)},loadOffline:function(){this.offlineMap.showLoading();var e=(offlineWidget.map,[]);offlineWidget.initDB(function(n){var o=offlineWidget.editStore,t=indexedDB.open(o.DB_NAME,11);t.onsuccess=function(n){var t=offlineWidget.map,a=n.target.result,l=a.transaction([o.DB_STORE_NAME],"readonly"),r=l.objectStore(o.DB_STORE_NAME),s=r.index("by_id"),f=s.openCursor(null,"next");f.onsuccess=function(n){var o=n.target.result;if(o){var i,t=o.value,a=new T(JSON.parse(t.featureLayerCollection)),l=[],r=a.fields;for(i=0;i<r.length;i++){var s=r.shift(),f={fieldName:s.name,label:s.alias,visible:!0};l.push(f)}var d=new L({title:a.name,fieldInfos:l});null===a.url&&(a.url=t.featureLayerUrl),a.infoTemplate=d,a.visible=!0,e.push(a),o["continue"]()}},l.oncomplete=function(n){console.log("transaction completed collecting layers from store"),promises=[];var o=[];for(i=0;i<e.length;i+=1)o.push({layer:e[i]});var a=t.on("layers-add-result",function(e){a.remove(),offlineWidget.toc.layers=o,offlineWidget.toc.refresh(),offlineWidget.offlineMap.hideLoading()});offlineWidget.map.addLayers(e)}},t.onerror=function(){alert("There was a problem retrieving feature layer options object. "+dataStore),callback(!1)}})},initDB:function(e){var n=offlineWidget.editStore;if(!n._isDBInit){var o=indexedDB.open(n.DB_NAME,11);o.onupgradeneeded=function(){var e=o.result,i=e.objectStoreNames;if(i.contains(n.DB_STORE_NAME))e.close();else{var t=e.createObjectStore(n.DB_STORE_NAME,{keyPath:"id"});t.createIndex("by_id","id",{unique:!0});e.close()}},o.onsuccess=function(){var e=o.result;e.close()},n._isDBInit=!0}e()},buildDatabase:function(e,o){var i=offlineWidget.editStore;i._featureLayers=[],offlineWidget.initDB(function(t){var a,l=new d,r=indexedDB.open(i.DB_NAME,11);r.onsuccess=function(o){a=o.target.result;var t=function(e){var n=offlineWidget.getFeatureLayerJSON(e);n.id=e.name;e.name+"_collection";e.offlineExtended=!0,e.objectIdField=i.DB_UID;var o=null;return e.url&&(o=e.url,i._featureLayers[e.url]=e),n},r=[];n.forEach(e,function(e){var n=new d,o=t(e);n.resolve(o),r.push(n)});var s=a.transaction(i.DB_STORE_NAME,"readwrite"),f=s.objectStore(i.DB_STORE_NAME),c=u(r);c.then(function(e){n.forEach(e,function(e){console.log(e),f.put(e),console.log("entry put")})}),s.oncomplete=function(){l.resolve("all features loaded into indexedDB")},s.onabort=function(){console.log(s.errorCode),l.resolve("error")}},r.onerror=function(e){console.log(e.target.errorCode),l.resolve("error")},l.then(function(e){o(e)})})},getFeatureLayerJSON:function(e){var n=offlineWidget.map;return{featureLayerCollection:JSON.stringify(e.toJson()),zoomLevel:n.getZoom(),centerPt:n.extent.getCenter().toJson(),featureLayerUrl:e.url}},updateFeatureLayerJSON:function(){var e=offlineWidget.testLayers;n.forEach(e,function(e){var n=offlineWidget.getFeatureLayerJSON(e);e.setFeatureLayerJSONDataStore(n,function(e,n){console.log("updateFeatureLayerJSON - Result: "+e+", error: "+n)})})}})});